<!doctype html><html lang=zh class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Welcome to Shise's notebook. This site serves as a personal knowledge base for me to record my thoughts and ideas. It is also a place for me to share my knowledge and experience with the world. I hope you find something useful here. "><meta name=author content=ShiSeAB><link href=https://shiseab.github.io/notebook/Compiler/ch13/ rel=canonical><link href=../ch11/ rel=prev><link href=../ch14/ rel=next><link rel=icon href=../../assets/images/favicon.png><meta name=generator content="mkdocs-1.6.1, mkdocs-material-9.6.17"><title>垃圾回收 - ShiSe的notebook</title><link rel=stylesheet href=../../assets/stylesheets/main.7e37652d.min.css><link rel=stylesheet href=../../assets/stylesheets/palette.06af60db.min.css><link rel=preconnect href=https://fonts.gstatic.com crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=LXGW+WenKai+Screen:300,300i,400,400i,700,700i%7CJetBrains+Mono:400,400i,700,700i&display=fallback"><style>:root{--md-text-font:"LXGW WenKai Screen";--md-code-font:"JetBrains Mono"}</style><link rel=stylesheet href=../../css/timeline.css><link rel=stylesheet href=https://gcore.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css><link rel=stylesheet href=https://gcore.jsdelivr.net/npm/lxgw-wenkai-screen-webfont@1.1.0/style.css><link rel=stylesheet href=https://gcore.jsdelivr.net/npm/lxgw-wenkai-webfont@1.1.0/style.css><link rel=stylesheet href=../../css/custom.css><link rel=stylesheet href=../../css/card.css><link rel=stylesheet href=../../css/tasklist.css><link rel=stylesheet href=../../css/flink.css><link rel=stylesheet href=../../css/more_changelog.css><script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=default data-md-color-accent=default> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#garbage-collection class=md-skip> 跳转至 </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header__inner md-grid" aria-label=页眉> <a href=../.. title=ShiSe的notebook class="md-header__button md-logo" aria-label=ShiSe的notebook data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg> </a> <label class="md-header__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg> </label> <div class=md-header__title data-md-component=header-title> <div class=md-header__ellipsis> <div class=md-header__topic> <span class=md-ellipsis> ShiSe的notebook </span> </div> <div class=md-header__topic data-md-component=header-topic> <span class=md-ellipsis> 垃圾回收 </span> </div> </div> </div> <form class=md-header__option data-md-component=palette> <input class=md-option data-md-color-media="(prefers-color-scheme: light)" data-md-color-scheme=default data-md-color-primary=default data-md-color-accent=default aria-label="Switch to dark mode" type=radio name=__palette id=__palette_0> <label class="md-header__button md-icon" title="Switch to dark mode" for=__palette_1 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 7a5 5 0 0 1 5 5 5 5 0 0 1-5 5 5 5 0 0 1-5-5 5 5 0 0 1 5-5m0 2a3 3 0 0 0-3 3 3 3 0 0 0 3 3 3 3 0 0 0 3-3 3 3 0 0 0-3-3m0-7 2.39 3.42C13.65 5.15 12.84 5 12 5s-1.65.15-2.39.42zM3.34 7l4.16-.35A7.2 7.2 0 0 0 5.94 8.5c-.44.74-.69 1.5-.83 2.29zm.02 10 1.76-3.77a7.131 7.131 0 0 0 2.38 4.14zM20.65 7l-1.77 3.79a7.02 7.02 0 0 0-2.38-4.15zm-.01 10-4.14.36c.59-.51 1.12-1.14 1.54-1.86.42-.73.69-1.5.83-2.29zM12 22l-2.41-3.44c.74.27 1.55.44 2.41.44.82 0 1.63-.17 2.37-.44z"/></svg> </label> <input class=md-option data-md-color-media="(prefers-color-scheme: dark)" data-md-color-scheme=slate data-md-color-primary=indigo data-md-color-accent=indigo aria-label="Switch to light mode" type=radio name=__palette id=__palette_1> <label class="md-header__button md-icon" title="Switch to light mode" for=__palette_0 hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="m17.75 4.09-2.53 1.94.91 3.06-2.63-1.81-2.63 1.81.91-3.06-2.53-1.94L12.44 4l1.06-3 1.06 3zm3.5 6.91-1.64 1.25.59 1.98-1.7-1.17-1.7 1.17.59-1.98L15.75 11l2.06-.05L18.5 9l.69 1.95zm-2.28 4.95c.83-.08 1.72 1.1 1.19 1.85-.32.45-.66.87-1.08 1.27C15.17 23 8.84 23 4.94 19.07c-3.91-3.9-3.91-10.24 0-14.14.4-.4.82-.76 1.27-1.08.75-.53 1.93.36 1.85 1.19-.27 2.86.69 5.83 2.89 8.02a9.96 9.96 0 0 0 8.02 2.89m-1.64 2.02a12.08 12.08 0 0 1-7.8-3.47c-2.17-2.19-3.33-5-3.49-7.82-2.81 3.14-2.7 7.96.31 10.98 3.02 3.01 7.84 3.12 10.98.31"/></svg> </label> </form> <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script> <label class="md-header__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=搜索 placeholder=搜索 autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg> </label> <nav class=md-search__options aria-label=查找> <button type=reset class="md-search__icon md-icon" title=清空当前内容 aria-label=清空当前内容 tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg> </button> </nav> </form> <div class=md-search__output> <div class=md-search__scrollwrap tabindex=0 data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> 正在初始化搜索引擎 </div> <ol class=md-search-result__list role=presentation></ol> </div> </div> </div> </div> </div> <div class=md-header__source> <a href=https://github.com/ShiSeAB/notebook.git/ title=前往仓库 class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill=currentColor d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg> </div> <div class=md-source__repository> ShiSeAB/notebook </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <nav class=md-tabs aria-label=标签 data-md-component=tabs> <div class=md-grid> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../.. class=md-tabs__link> HOME </a> </li> <li class=md-tabs__item> <a href=../../RL/ class=md-tabs__link> AI </a> </li> <li class="md-tabs__item md-tabs__item--active"> <a href=../ class=md-tabs__link> CS课程 </a> </li> <li class=md-tabs__item> <a href=../../essays/ class=md-tabs__link> 论文阅读 </a> </li> </ul> </div> </nav> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=sidebar data-md-type=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary md-nav--lifted" aria-label=导航栏 data-md-level=0> <label class=md-nav__title for=__drawer> <a href=../.. title=ShiSe的notebook class="md-nav__button md-logo" aria-label=ShiSe的notebook data-md-component=logo> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg> </a> ShiSe的notebook </label> <div class=md-nav__source> <a href=https://github.com/ShiSeAB/notebook.git/ title=前往仓库 class=md-source data-md-component=source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><!-- Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill=currentColor d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg> </div> <div class=md-source__repository> ShiSeAB/notebook </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_1> <div class="md-nav__link md-nav__container"> <a href=../.. class="md-nav__link "> <span class=md-ellipsis> HOME </span> </a> <label class="md-nav__link " for=__nav_1 id=__nav_1_label tabindex=0> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_1_label aria-expanded=false> <label class=md-nav__title for=__nav_1> <span class="md-nav__icon md-icon"></span> HOME </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../link/ class=md-nav__link> <span class=md-ellipsis> 友链 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2> <label class=md-nav__link for=__nav_2 id=__nav_2_label tabindex=0> <span class=md-ellipsis> AI </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_2_label aria-expanded=false> <label class=md-nav__title for=__nav_2> <span class="md-nav__icon md-icon"></span> AI </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_1> <div class="md-nav__link md-nav__container"> <a href=../../RL/ class="md-nav__link "> <span class=md-ellipsis> 强化学习 </span> </a> <label class="md-nav__link " for=__nav_2_1 id=__nav_2_1_label tabindex=0> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_1_label aria-expanded=false> <label class=md-nav__title for=__nav_2_1> <span class="md-nav__icon md-icon"></span> 强化学习 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../RL/basic_1/ class=md-nav__link> <span class=md-ellipsis> 基础知识 </span> </a> </li> <li class=md-nav__item> <a href=../../RL/TRPO/ class=md-nav__link> <span class=md-ellipsis> TRPO </span> </a> </li> <li class=md-nav__item> <a href=../../RL/PPO/ class=md-nav__link> <span class=md-ellipsis> PPO </span> </a> </li> <li class=md-nav__item> <a href=../../RL/GRPO/ class=md-nav__link> <span class=md-ellipsis> GRPO </span> </a> </li> <li class=md-nav__item> <a href=../../essays/DAPO/ class=md-nav__link> <span class=md-ellipsis> DAPO </span> </a> </li> <li class=md-nav__item> <a href=../../essays/VAPO/ class=md-nav__link> <span class=md-ellipsis> VAPO </span> </a> </li> <li class=md-nav__item> <a href=../../RL/Reward%20model/ class=md-nav__link> <span class=md-ellipsis> Reward Model </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_2_2> <div class="md-nav__link md-nav__container"> <a href=../../DeepLearning/ class="md-nav__link "> <span class=md-ellipsis> 深度学习 </span> </a> <label class="md-nav__link " for=__nav_2_2 id=__nav_2_2_label tabindex=0> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_2_2_label aria-expanded=false> <label class=md-nav__title for=__nav_2_2> <span class="md-nav__icon md-icon"></span> 深度学习 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../DeepLearning/Convolution/ class=md-nav__link> <span class=md-ellipsis> 卷积神经网络 </span> </a> </li> <li class=md-nav__item> <a href=../../DeepLearning/Modern%20CNN/ class=md-nav__link> <span class=md-ellipsis> 现代卷积神经网络架构 </span> </a> </li> <li class=md-nav__item> <a href=../../DeepLearning/Recurrent%20neural%20network/ class=md-nav__link> <span class=md-ellipsis> 循环神经网络 </span> </a> </li> <li class=md-nav__item> <a href=../../DeepLearning/Modern%20RNN/ class=md-nav__link> <span class=md-ellipsis> 现代循环神经网络 </span> </a> </li> <li class=md-nav__item> <a href="../../DeepLearning/Attention Mechanisms" class=md-nav__link> <span class=md-ellipsis> 注意力机制 </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3 checked> <label class=md-nav__link for=__nav_3 id=__nav_3_label tabindex> <span class=md-ellipsis> CS课程 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_3_label aria-expanded=true> <label class=md-nav__title for=__nav_3> <span class="md-nav__icon md-icon"></span> CS课程 </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_1 checked> <div class="md-nav__link md-nav__container"> <a href=../ class="md-nav__link "> <span class=md-ellipsis> 编译原理 </span> </a> <label class="md-nav__link " for=__nav_3_1 id=__nav_3_1_label tabindex=0> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_1_label aria-expanded=true> <label class=md-nav__title for=__nav_3_1> <span class="md-nav__icon md-icon"></span> 编译原理 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../Introduction/ class=md-nav__link> <span class=md-ellipsis> Introduction </span> </a> </li> <li class=md-nav__item> <a href=../Lexical_Analysis/ class=md-nav__link> <span class=md-ellipsis> 词法分析 </span> </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_1_4> <label class=md-nav__link for=__nav_3_1_4 id=__nav_3_1_4_label tabindex=0> <span class=md-ellipsis> 语法分析 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=3 aria-labelledby=__nav_3_1_4_label aria-expanded=false> <label class=md-nav__title for=__nav_3_1_4> <span class="md-nav__icon md-icon"></span> 语法分析 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../Parsing/ class=md-nav__link> <span class=md-ellipsis> Top-Down </span> </a> </li> <li class=md-nav__item> <a href=../Parsing-2/ class=md-nav__link> <span class=md-ellipsis> Bottom-Up </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../Abstract_Syntax/ class=md-nav__link> <span class=md-ellipsis> 抽象语法 </span> </a> </li> <li class=md-nav__item> <a href=../Semantic_Analysis/ class=md-nav__link> <span class=md-ellipsis> 语义分析 </span> </a> </li> <li class=md-nav__item> <a href=../Activation_Record/ class=md-nav__link> <span class=md-ellipsis> 活动记录 </span> </a> </li> <li class=md-nav__item> <a href=../ch7-IR/ class=md-nav__link> <span class=md-ellipsis> 中间代码生成 </span> </a> </li> <li class=md-nav__item> <a href=../ch8/ class=md-nav__link> <span class=md-ellipsis> 基本块 </span> </a> </li> <li class=md-nav__item> <a href=../ch9/ class=md-nav__link> <span class=md-ellipsis> 指令选择 </span> </a> </li> <li class=md-nav__item> <a href=../ch10/ class=md-nav__link> <span class=md-ellipsis> 活跃变量分析 </span> </a> </li> <li class=md-nav__item> <a href=../ch11/ class=md-nav__link> <span class=md-ellipsis> 寄存器分配 </span> </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> <span class=md-ellipsis> 垃圾回收 </span> <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> <span class=md-ellipsis> 垃圾回收 </span> </a> <nav class="md-nav md-nav--secondary" aria-label=目录> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> 目录 </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#introduction class=md-nav__link> <span class=md-ellipsis> Introduction </span> </a> </li> <li class=md-nav__item> <a href=#mark-and-sweep class=md-nav__link> <span class=md-ellipsis> Mark-and-Sweep </span> </a> <nav class=md-nav aria-label=Mark-and-Sweep> <ul class=md-nav__list> <li class=md-nav__item> <a href=#overview class=md-nav__link> <span class=md-ellipsis> Overview </span> </a> </li> <li class=md-nav__item> <a href=#explicit-stack class=md-nav__link> <span class=md-ellipsis> Explicit Stack </span> </a> </li> <li class=md-nav__item> <a href=#pointer-reversal class=md-nav__link> <span class=md-ellipsis> Pointer Reversal </span> </a> </li> <li class=md-nav__item> <a href=#memory-fragmentation class=md-nav__link> <span class=md-ellipsis> Memory Fragmentation </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#reference-counting class=md-nav__link> <span class=md-ellipsis> Reference Counting </span> </a> </li> <li class=md-nav__item> <a href=#copying-collection class=md-nav__link> <span class=md-ellipsis> Copying Collection </span> </a> <nav class=md-nav aria-label="Copying Collection"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#cheney class=md-nav__link> <span class=md-ellipsis> Cheney 算法 </span> </a> </li> <li class=md-nav__item> <a href=#pointer-forwarding class=md-nav__link> <span class=md-ellipsis> Pointer Forwarding </span> </a> </li> <li class=md-nav__item> <a href=#locality class=md-nav__link> <span class=md-ellipsis> Locality </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#interface-to-the-compiler class=md-nav__link> <span class=md-ellipsis> Interface to the Compiler </span> </a> <nav class=md-nav aria-label="Interface to the Compiler"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#fast-allocation class=md-nav__link> <span class=md-ellipsis> Fast Allocation </span> </a> </li> <li class=md-nav__item> <a href=#describing-data-layouts class=md-nav__link> <span class=md-ellipsis> Describing Data Layouts </span> </a> </li> <li class=md-nav__item> <a href=#describing-roots-pointer-map class=md-nav__link> <span class=md-ellipsis> Describing Roots (Pointer Map) </span> </a> </li> <li class=md-nav__item> <a href=#derived-pointers class=md-nav__link> <span class=md-ellipsis> Derived Pointers </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../ch14/ class=md-nav__link> <span class=md-ellipsis> 面向对象语言 </span> </a> </li> <li class=md-nav__item> <a href=../ch18/ class=md-nav__link> <span class=md-ellipsis> 循环优化 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_2> <label class=md-nav__link for=__nav_3_2 id=__nav_3_2_label tabindex=0> <span class=md-ellipsis> 自然语言处理导论 </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_2_label aria-expanded=false> <label class=md-nav__title for=__nav_3_2> <span class="md-nav__icon md-icon"></span> 自然语言处理导论 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../nlp/Deep%20Learning%20Basic/ class=md-nav__link> <span class=md-ellipsis> 深度学习基础 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_3_3> <div class="md-nav__link md-nav__container"> <a href=../../Micro_processor/ class="md-nav__link "> <span class=md-ellipsis> 汇编与接口 </span> </a> </div> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_3_3_label aria-expanded=false> <label class=md-nav__title for=__nav_3_3> <span class="md-nav__icon md-icon"></span> 汇编与接口 </label> <ul class=md-nav__list data-md-scrollfix> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4> <div class="md-nav__link md-nav__container"> <a href=../../essays/ class="md-nav__link "> <span class=md-ellipsis> 论文阅读 </span> </a> <label class="md-nav__link " for=__nav_4 id=__nav_4_label tabindex=0> <span class="md-nav__icon md-icon"></span> </label> </div> <nav class=md-nav data-md-level=1 aria-labelledby=__nav_4_label aria-expanded=false> <label class=md-nav__title for=__nav_4> <span class="md-nav__icon md-icon"></span> 论文阅读 </label> <ul class=md-nav__list data-md-scrollfix> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_2> <label class=md-nav__link for=__nav_4_2 id=__nav_4_2_label tabindex=0> <span class=md-ellipsis> RL </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_4_2_label aria-expanded=false> <label class=md-nav__title for=__nav_4_2> <span class="md-nav__icon md-icon"></span> RL </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../essays/DeepSeek-R1/ class=md-nav__link> <span class=md-ellipsis> DeepSeek-R1 </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_3> <label class=md-nav__link for=__nav_4_3 id=__nav_4_3_label tabindex=0> <span class=md-ellipsis> CoT </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_4_3_label aria-expanded=false> <label class=md-nav__title for=__nav_4_3> <span class="md-nav__icon md-icon"></span> CoT </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../essays/TokenSkip/ class=md-nav__link> <span class=md-ellipsis> TokenSkip </span> </a> </li> <li class=md-nav__item> <a href=../../essays/DEER/ class=md-nav__link> <span class=md-ellipsis> DEER </span> </a> </li> <li class=md-nav__item> <a href=../../essays/ThoughtTerminator/ class=md-nav__link> <span class=md-ellipsis> ThoughtTerminator </span> </a> </li> <li class=md-nav__item> <a href=../../essays/SEAL/ class=md-nav__link> <span class=md-ellipsis> SEAL </span> </a> </li> <li class=md-nav__item> <a href=../../essays/MRL/ class=md-nav__link> <span class=md-ellipsis> MRT </span> </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle " type=checkbox id=__nav_4_4> <label class=md-nav__link for=__nav_4_4 id=__nav_4_4_label tabindex=0> <span class=md-ellipsis> Social </span> <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav data-md-level=2 aria-labelledby=__nav_4_4_label aria-expanded=false> <label class=md-nav__title for=__nav_4_4> <span class="md-nav__icon md-icon"></span> Social </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../essays/Social/SocialGenome/ class=md-nav__link> <span class=md-ellipsis> SocialGenome </span> </a> </li> <li class=md-nav__item> <a href=../../essays/Social/MiMeQA/ class=md-nav__link> <span class=md-ellipsis> MiMeQA </span> </a> </li> <li class=md-nav__item> <a href=../../essays/Social/EgoToM/ class=md-nav__link> <span class=md-ellipsis> EgoToM </span> </a> </li> <li class=md-nav__item> <a href=../../essays/Social/Text-Social%20Benchmark/ class=md-nav__link> <span class=md-ellipsis> TextSocial </span> </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=sidebar data-md-type=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label=目录> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> 目录 </label> <ul class=md-nav__list data-md-component=toc data-md-scrollfix> <li class=md-nav__item> <a href=#introduction class=md-nav__link> <span class=md-ellipsis> Introduction </span> </a> </li> <li class=md-nav__item> <a href=#mark-and-sweep class=md-nav__link> <span class=md-ellipsis> Mark-and-Sweep </span> </a> <nav class=md-nav aria-label=Mark-and-Sweep> <ul class=md-nav__list> <li class=md-nav__item> <a href=#overview class=md-nav__link> <span class=md-ellipsis> Overview </span> </a> </li> <li class=md-nav__item> <a href=#explicit-stack class=md-nav__link> <span class=md-ellipsis> Explicit Stack </span> </a> </li> <li class=md-nav__item> <a href=#pointer-reversal class=md-nav__link> <span class=md-ellipsis> Pointer Reversal </span> </a> </li> <li class=md-nav__item> <a href=#memory-fragmentation class=md-nav__link> <span class=md-ellipsis> Memory Fragmentation </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#reference-counting class=md-nav__link> <span class=md-ellipsis> Reference Counting </span> </a> </li> <li class=md-nav__item> <a href=#copying-collection class=md-nav__link> <span class=md-ellipsis> Copying Collection </span> </a> <nav class=md-nav aria-label="Copying Collection"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#cheney class=md-nav__link> <span class=md-ellipsis> Cheney 算法 </span> </a> </li> <li class=md-nav__item> <a href=#pointer-forwarding class=md-nav__link> <span class=md-ellipsis> Pointer Forwarding </span> </a> </li> <li class=md-nav__item> <a href=#locality class=md-nav__link> <span class=md-ellipsis> Locality </span> </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#interface-to-the-compiler class=md-nav__link> <span class=md-ellipsis> Interface to the Compiler </span> </a> <nav class=md-nav aria-label="Interface to the Compiler"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#fast-allocation class=md-nav__link> <span class=md-ellipsis> Fast Allocation </span> </a> </li> <li class=md-nav__item> <a href=#describing-data-layouts class=md-nav__link> <span class=md-ellipsis> Describing Data Layouts </span> </a> </li> <li class=md-nav__item> <a href=#describing-roots-pointer-map class=md-nav__link> <span class=md-ellipsis> Describing Roots (Pointer Map) </span> </a> </li> <li class=md-nav__item> <a href=#derived-pointers class=md-nav__link> <span class=md-ellipsis> Derived Pointers </span> </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content data-md-component=content> <article class="md-content__inner md-typeset"> <h1 id=garbage-collection>Garbage Collection<a class=headerlink href=#garbage-collection title="Permanent link">&para;</a></h1> <h2 id=introduction>Introduction<a class=headerlink href=#introduction title="Permanent link">&para;</a></h2> <p><strong>Runtime System</strong> : 程序运行时语言隐式依赖的一些机制，例如:</p> <ul> <li>Handling of POSIX signals 信号处理</li> <li>Virtual machine execution 虚拟机执行</li> <li>Class loading 类加载</li> <li><strong>Automated memory management</strong> 自动内存管理</li> </ul> <p>接下来介绍内存管理，手动内存管理容易出现 Double frees, use-after frees, Memory leak, fragmentation, … 存储错误难以排除，为了 performance, productivity, safety &amp; security，使用自动内存管理。</p> <p>Memory 主要区域：</p> <ul> <li>Static area：Allocated at compile time</li> <li>run-time stack ：存储 Activation records ，managing function calls and returns</li> <li><strong>Heap</strong> ：Dynamically allocated objects，垃圾回收主要关注对象</li> </ul> <p>那么，Gaebage 的定义为：Allocated but no longer used heap storage 。例如一个对象被分配了内存，但是没有任何指针指向它：</p> <p><img alt=image-20250604114948240 src=../ch13.assets/image-20250604114948240.png></p> <p>Garbage Collection：automatically frees storage which is not used by the program any more。</p> <ul> <li>phase 1：Garbage detection，找出哪些对象 alive，哪些对象 dead</li> <li>phase 2：Garbage reclaimation，deallocates dead objects</li> </ul> <p>判断 memory cell 是否 “not any longer used”是 undecidable 的问题（halting problem相关），需要用到 conservative approximation 来保证 GC 的安全性。</p> <p>其中，<strong>reachability</strong> 作为近似标准，如果 Heap-allocated records，从程序变量出发，通过任何指针链都是 unreachable 的，那么认为该 record 为 garbage。</p> <p>所以： <span class=arithmatex>\(unreachable \rightarrow not~live(no~longer~used)\)</span></p> <p><strong>GC Techniques</strong> </p> <ul> <li>Reference counting : 直接跟踪存活单元，GC在堆块分配时发生，但不能检测所有垃圾（如循环引用）.</li> <li>Tracing : 当内存请求失败时，GC启动并识别存活单元。</li> <li>Mark-sweep</li> <li> <p>Copy collection</p> </li> <li> <p>Modern techniques : generational GC, etc.</p> </li> </ul> <p><strong>Basic Data Structure : Directed Graph</strong> </p> <ul> <li><strong>nodes</strong> : program variables and heap-allocated records</li> <li><strong>edges</strong> : pointers (p points to a record y means value of p is the address of y， 即指针 y == *p)</li> <li><strong>Root</strong> : program variables</li> <li>Registers</li> <li>Local vars/formal parameters on stack</li> <li>global variables</li> <li><strong>reachable</strong> : 如果存在从某个根 r 到节点 n 的有向路径 (r→⋯→n)，则节点 n 是可达的。</li> </ul> <p><strong>Additional Basic Data Structures: Freelist</strong></p> <ul> <li>memory manager 需要知道堆的哪些部分是空闲的</li> <li>Freelist 则将所有空闲堆块链接 (linked list) 起来，供 GC 算法使用</li> </ul> <p><strong>Different Ways for Allocation</strong></p> <p>memory manager 知道堆的哪些部分是空闲的，哪些被分配。</p> <ul> <li><strong>Linear allocation</strong> ： 连续内存区域中依次分配</li> <li><strong>Freelist allocation</strong> ：从空闲链表中取用适合块</li> </ul> <h2 id=mark-and-sweep>Mark-and-Sweep<a class=headerlink href=#mark-and-sweep title="Permanent link">&para;</a></h2> <h3 id=overview>Overview<a class=headerlink href=#overview title="Permanent link">&para;</a></h3> <p><strong>Mark phase</strong> : 从 roots 开始进行图搜索，被搜索到的node被标记(mark)</p> <ul> <li>depth-first search，标记所有 reachable nodes</li> </ul> <p><img alt=image-20250604212332514 src=../ch13.assets/image-20250604212332514.png></p> <p>x的值是某record的地址，换句话说它指向该record。</p> <p><strong>Sweep phase</strong> : 线性扫描整个堆，将未被 mark 的 nodes （garbage）放入一个 freelist，然后 Unmark marked nodes （为下一次 GC 做准备）</p> <p><img alt=image-20250604212943243 src=../ch13.assets/image-20250604212943243.png></p> <p>GC 以后，程序恢复执行，当需要分配新纪录时，从 freelist 中获取，当 freelist 为空时，触发 GC。</p> <p>例：</p> <p><img alt=image-20250604213207493 src=../ch13.assets/image-20250604213207493.png></p> <p><strong>Cost of Mark-and-Sweep</strong> R = words of reachable data; H = total heap size (in words); c1 = marking cost per word; c2 = sweeping cost per word 总时间：<span class=arithmatex>\(c_1R+c_2H\)</span> ; 每分配一个 word 的成本 ：<span class=arithmatex>\((c_1R+c_2H)/(H-R)\)</span></p> <ul> <li>当 R 很接近 H 时，cost 会非常昂贵</li> <li>If H is much larger than R, cost approaches <span class=arithmatex>\(c_2\)</span></li> <li>If R/H &gt; 0.5 after collection, heap should be enlarged</li> </ul> <h3 id=explicit-stack>Explicit Stack<a class=headerlink href=#explicit-stack title="Permanent link">&para;</a></h3> <p><strong>递归DFS的栈溢出</strong>：如果递归深度过大，可能导致 DFS 函数的栈溢出。</p> <p>使用 <strong>Explicit Stack</strong></p> <p><img alt=image-20250604222954124 src=../ch13.assets/image-20250604222954124.png></p> <p>但是 Explicit Stack 最坏情况下可能和堆一样大，仍然不可接受。（？为什么不能一样大，好吧确实有点太大了）</p> <h3 id=pointer-reversal>Pointer Reversal<a class=headerlink href=#pointer-reversal title="Permanent link">&para;</a></h3> <p>DFS 遍历过程中，不使用 Explicit Stack ，而是使用 Pointer reversal 方法，即 Deutsch-Schorr-Waite (DSW) algo，利用被遍历对象自身的指针字段来存储返回路径（父节点信息）。</p> <p>当 search 时遇到 new record ，首先 mark；然后修改 record 中的一个指针，使其指向父 record；当无法再深入时，沿着反转指针返回，并恢复原始指针。</p> <p>例：</p> <p><img alt=image-20250605113236521 src=../ch13.assets/image-20250605113236521.png></p> <p>一条路 search 到 deepest，return：</p> <p><img alt=image-20250605113437391 src=../ch13.assets/image-20250605113437391.png></p> <p><img alt=image-20250605113447665 src=../ch13.assets/image-20250605113447665.png></p> <p>探索另一条 path：</p> <p><img alt=image-20250605113528848 src=../ch13.assets/image-20250605113528848.png></p> <p>return：</p> <p><img alt=image-20250605113546569 src=../ch13.assets/image-20250605113546569.png></p> <p>总结算法：</p> <p><img alt=image-20250605113948727 src=../ch13.assets/image-20250605113948727.png></p> <ul> <li><code>x</code>: 当前处理的节点。</li> <li><code>t</code>: 父节点，用于回溯。</li> <li><code>done[node]</code>: 记录节点中已处理的字段数量。</li> <li><code>y</code>: 临时存储子节点或字段值。</li> </ul> <p>例：</p> <p>首先 mark A，Set done[A] = 0，Set t = nil</p> <p><img alt=image-20250605115239718 src=../ch13.assets/image-20250605115239718.png></p> <p>然后处理 A 的 left field，将A’s left pointer替换为 t = nil，并将 A 放在 t 中，标记 B，此时 <code>x=B,t=A,i=0,y=B,done[A]=0,done[B]=0</code></p> <p><img alt=image-20250605115307227 src=../ch13.assets/image-20250605115307227.png></p> <p>接着处理 B 的 value field，处理完后返回 A , 返回执行最后一个 else （得 <code>x=A,t=A,i=0,y=B,i=0,done[A]=1,done[B]=1</code>）</p> <p><img alt=image-20250605115335372 src=../ch13.assets/image-20250605115335372.png></p> <p>最后处理 A 自身的 data field：</p> <p><img alt=image-20250605115401001 src=../ch13.assets/image-20250605115401001.png></p> <p><img alt=image-20250605120047075 src=../ch13.assets/image-20250605120047075.png></p> <h3 id=memory-fragmentation>Memory Fragmentation<a class=headerlink href=#memory-fragmentation title="Permanent link">&para;</a></h3> <p><strong>External fragmentation</strong> ：堆中有足够的空闲总空间，但没有一块连续的空闲空间能满足当前的分配请求。</p> <p><img alt=image-20250605120441436 src=../ch13.assets/image-20250605120441436.png></p> <p><strong>Internal fragmentation</strong> ：分配给对象的内存块大于对象实际需要的大小，导致对象内部存在未使用的内存。</p> <p><img alt=image-20250605120451816 src=../ch13.assets/image-20250605120451816.png></p> <p>Mark-and-Sweep 倾向于产生外部碎片。</p> <p><strong>Summary：</strong></p> <p><em>Pros</em> ：</p> <ul> <li>High efficiency if little garbage exist.</li> <li>Be able to collect cyclic references.</li> <li>Objects/records are not moved during GC</li> </ul> <p><em>Cons</em> ：</p> <ul> <li>Low efficiency with large amount of garbage</li> <li>Normal execution must be suspended</li> <li>Leads to fragmentation in the heap (Cache misses, page thrashing, complex allocation, etc.)</li> </ul> <h2 id=reference-counting>Reference Counting<a class=headerlink href=#reference-counting title="Permanent link">&para;</a></h2> <p>为堆中的每个记录维护一个 <strong>reference count</strong> ，表示有多少个指针指向该记录。当一个记录的引用计数值变为0时，说明该记录不再被任何指针引用，即成为垃圾，可以被回收。</p> <p>比 mark-and-sweep 更渴望回收：一旦不可达立即回收，而 <span class=arithmatex>\(reference\_count(x)=0\rightarrow\)</span> x is unreachable</p> <p>赋值操作操控 reference count :</p> <ul> <li>Whenever p is stored into x.fi (i.e., x.fi = p) : p 的 reference count 自增，x.fi 之前指向的对象的 reference count 自减</li> <li>If the reference count of some record r reaches zero : 将 r 放入 freelist , r 指向的所有 records 的 reference count 自减（可能导致连锁回收） </li> </ul> <p><strong>Strength</strong> ：</p> <ul> <li>Incremental overhead: 单元管理与程序执行交错进行，没有明显的 “stop-and-collection” 效应。</li> <li>与手动内存管理共存</li> <li>可以立即重用释放单元</li> </ul> <p><strong>Limitations</strong> ：</p> <ul> <li>无法回收循环引用 Cycles of garbage ： 如果一组对象形成循环引用，即使这组对象整体已经不可达，组内对象 reference count 不为0，无法回收)。可用混合 GC 解决（定期运行标记-清除回收循环引用）</li> </ul> <p><img alt=image-20250605133658512 src=../ch13.assets/image-20250605133658512.png></p> <ul> <li>性能开销大 (Performance overhead)：每次指针赋值操作都需要执行多次读写内存来更新引用计数，开销远大于简单的指针赋值指令</li> </ul> <p><img alt=image-20250605133736529 src=../ch13.assets/image-20250605133736529.png></p> <h2 id=copying-collection>Copying Collection<a class=headerlink href=#copying-collection title="Permanent link">&para;</a></h2> <p>将 Memory 分为两个 heaps</p> <ul> <li>from-space: the one used by program</li> <li>to-space: the one unused until GC time</li> </ul> <p>当 from-space 满后，GC 启动，将 from-space 中的可达对象复制到 to-space；接下来，from-space 中的所有对象可被认为是 garbage，全部清理；Swap roles of from-space and to-space for next collection</p> <p><img alt=image-20250605134700865 src=../ch13.assets/image-20250605134700865.png></p> <ul> <li><strong>Very fast allocation</strong> (因为新的 from-space 是连续的空闲空间，just increment pointer): p=next, next=next + n</li> <li><strong>No fragmentation</strong>: 所有存活的对象都被紧凑地排列在 to-space 的开始部分，消除了外部碎片问题。</li> </ul> <p>该方法需要解决的关键问题是：复制所有可达对象、保持对象间的指针关系并避免多次复制同一个对象。</p> <h3 id=cheney>Cheney 算法<a class=headerlink href=#cheney title="Permanent link">&para;</a></h3> <p>对于复杂的嵌套数据结构以及很长的指针链，如果只是简单的 recursive copying ，会导致 stack overflow. </p> <p><strong>Cheney’s insight</strong> ：在 to-space 中使用 work queue，避免了 BFS queue 的额外内存开销</p> <p>将 to-space 分为三块连续的 region：</p> <ul> <li><strong>Copied</strong>: the record is copied, but we haven’t yet looked at pointers inside the record（已复制但未扫描），BFS queue</li> <li><strong>Copied and scanned</strong>: the record is copied, and we have processed all pointers in the record</li> <li><strong>empty</strong> ：空闲区域</li> </ul> <p><img alt=image-20250605140606049 src=../ch13.assets/image-20250605140606049.png></p> <ul> <li>scan 指针指向下一个需要被扫描处理的对象: 在to-space中、已经被复制但其内部指针字段还没有被处理的对象。对象被扫描时，scan++。</li> <li>next指针指向to-space中的<strong>空闲位置</strong>，也就是下一个要被复制到to space的对象将存放的位置，对象被 copy 时，next++。</li> <li>当最终 scan == next 时，说明所有 reachable objects 都被复制且扫描了，BFS queue 为空，遍历完成。</li> </ul> <p><img alt=image-20250605141100289 src=../ch13.assets/image-20250605141100289.png></p> <ul> <li>初始化 <code>scan</code> 和 <code>next</code> 指针都指向 to-space 的起始位置</li> <li>遍历所有根集合中的指针。对于每个根指针 <code>r</code> ，调用 <code>Forward(r)</code> 函数，将 <code>r</code> 指向的对象从 from-space 复制到 to-space (如果尚未复制)，并更新 <code>r</code> 指向 to-space 中的新地址。<code>next</code> 指针相应移动。</li> <li>当 <code>scan &lt; next</code> 时，循环执行：</li> <li>获取 <code>scan</code> 指针指向的对象（设为 <code>current_obj</code>）。</li> <li>遍历 <code>current_obj</code> 中的所有指针字段 <code>fi</code>。</li> <li>对每个字段 <code>fi</code>，调用 <code>scan.fi = Forward(scan.fi)</code>，将其指向的对象复制到 to-space (如果需要)，并更新 <code>scan.fi</code> 指向 to-space 中的新地址。体现了一个 BFS 思想。</li> <li>将 <code>scan</code> 指针移动到 to-space 中的下一个已复制对象 ( <code>scan = scan + size_of_record_at_scan</code>)。</li> <li>当 <code>scan</code> 追上 <code>next</code> 时，表示所有可达对象都已复制并扫描完毕，GC完成。</li> </ul> <p>例：</p> <p><img alt=image-20250605142933772 src=../ch13.assets/image-20250605142933772.png></p> <p><img alt=image-20250605143033930 src=../ch13.assets/image-20250605143033930.png></p> <p><img alt=image-20250605143257576 src=../ch13.assets/image-20250605143257576.png></p> <p><img alt=image-20250605143322478 src=../ch13.assets/image-20250605143322478.png></p> <p><img alt=image-20250605143332690 src=../ch13.assets/image-20250605143332690.png></p> <h3 id=pointer-forwarding>Pointer Forwarding<a class=headerlink href=#pointer-forwarding title="Permanent link">&para;</a></h3> <p>Cheney 算法中的关键辅助函数 -- <code>Forward(p)</code> </p> <ul> <li><strong>Goal</strong> : Locate an object's new position; Ensure all pointers correctly reference the new copies</li> </ul> <p>在 copy 一个 obj 后，把 obj 的 first field 改为指向 new location 的 pointer（ <strong>forwarding pointer</strong> to the new copy），通过寻找 forwarding pointer 来确定 ojb 是否被 copy。</p> <p><img alt=image-20250605150339881 src=../ch13.assets/image-20250605150339881.png></p> <ul> <li>如果 <code>p</code> 指向 from-space 中的对象：检查该对象是否已经有一个指向 to-space 的转发指针（即 <code>p.f1</code> 指向 to-space）。已复制可直接返回 <code>p.f1</code></li> <li>未复制则在 to-space 的 <code>next</code> 位置为该对象分配空间，并将对象内容从 from-space 复制过来。<code>p.f1</code> 存 to-space 中的新位置的转发指针；更新next指针，返回 <code>p.f1</code></li> <li>如果 <code>p</code> 不指向 <code>from-space</code> （already in to-space or isn't a pointer） ，直接返回 p</li> </ul> <p>例：</p> <p><img alt=image-20250605151919693 src=../ch13.assets/image-20250605151919693.png></p> <p><img alt=image-20250605152109987 src=../ch13.assets/image-20250605152109987.png></p> <p><img alt=image-20250605152139157 src=../ch13.assets/image-20250605152139157.png></p> <p>next <em>←</em> next <em>+size of record p</em></p> <p><img alt=image-20250605152200015 src=../ch13.assets/image-20250605152200015.png></p> <p>scan ← scan + size of record at scan：</p> <p><img alt=image-20250605152231183 src=../ch13.assets/image-20250605152231183.png></p> <p>例：</p> <p><img alt=image-20250605152514920 src=../ch13.assets/image-20250605152514920.png></p> <p><img alt=image-20250605152904008 src=../ch13.assets/image-20250605152904008.png></p> <h3 id=locality>Locality<a class=headerlink href=#locality title="Permanent link">&para;</a></h3> <p>BFS has poor locality : BFS会导致逻辑上相关的对象（如树的父子节点）在物理内存中可能相距较远，影响缓存性能。而 DFS 的复制策略有更好的 locality : 它倾向于将数据结构中通过指针链紧密相连的对象放置在内存中相邻的位置。</p> <p>可以混合 DFS 和 BFS 进行复制来改善 Locality。算法不考，但会涉及 locality 概念。</p> <p>思路：复制一个对象时，尝试立即复制它的一个子对象，并尽可能沿着这条路径进行 DFS 复制。当深度优先路径中断（例如遇到null指针或已复制对象）时，算法回退到广度优先扫描（类似Cheney算法的<code>scan</code>指针推进）来处理剩余的已复制但未扫描的对象。</p> <p><img alt=image-20250605153826693 src=../ch13.assets/image-20250605153826693.png></p> <p><strong>Summary</strong></p> <p>优点：</p> <ul> <li>简单，不需要栈或指针反转。</li> <li>运行时间与存活对象数量成正比（不扫描整个堆）。</li> <li>自动整理内存，消除碎片。</li> </ul> <p>缺点：</p> <ul> <li>浪费一半的内存空间。</li> <li>（Cheney算法）局部性可能较差。</li> <li>需要精确的类型信息来区分指针和非指针数据。</li> </ul> <p>总的来说，copy collection 适合那些可以容忍较高内存开销，但对分配速度和避免碎片有高要求的系统，例如许多函数式语言的运行时环境。</p> <h2 id=interface-to-the-compiler>Interface to the Compiler<a class=headerlink href=#interface-to-the-compiler title="Permanent link">&para;</a></h2> <p>编译器在支持垃圾回收时，需要与GC机制进行交互。虎书介绍了如下几个方面：</p> <ul> <li>Generating code that <strong>allocate</strong> <strong>records</strong></li> <li>Describing locations of <strong>roots</strong> <strong>for each garbage collection cycle</strong></li> <li>Describing the <strong>layout</strong> <strong>of data records</strong> on the heap</li> <li>Generating instructions to implement a read or write barrier</li> </ul> <h3 id=fast-allocation>Fast Allocation<a class=headerlink href=#fast-allocation title="Permanent link">&para;</a></h3> <p>对象分配是程序运行过程中的高频操作，其效率直接影响整体性能，对于 Functional languages（鼓励创建新对象而非修改旧对象）和 Memory-intensive applications 尤其如此 。而且，某些程序中多达 1/7 的 inst 是存储指令，这意味着分配操作的频率可能相当高。</p> <p>由于 Copying Collection 不产生碎片，内存分配可以非常高效。allocation space（即 to-space） 是一块连续空闲区域，<code>next</code>指针指向下一个可用内存的起始位置，<code>limit</code>指针指向该区域的末尾 .</p> <p>给大小为 N 的 record 分配流程：</p> <ol> <li>Call the allocate function </li> <li>Test <em>next + N &lt; limit</em> ? (If the test fails, call GC)</li> <li>Move <em>next</em> to <em>result</em></li> <li>Clear <em>M[next],</em> <em>M[next+1],</em> ..., <em>M[next + N - 1]</em> 将分配区域清0</li> <li>next <span class=arithmatex>\(\leftarrow\)</span> next + N ，更新 next</li> <li>Return from the allocate function</li> </ol> <p>A. Move result into some computationally useful place</p> <p>B. Store useful values into the record</p> <p>为了进一步降低分配开销，使用 inline expanding 消除 step1&amp;6；将 step A与3结合起来；step B 可覆盖 step 4；step 2&amp;5不可消除，但可以通过将 <code>next</code> 和 <code>limit</code> 指针保存在寄存器中，以减少指令数至 3条。</p> <p>最终 内存分配指令数可只用 4 条。</p> <h3 id=describing-data-layouts>Describing Data Layouts<a class=headerlink href=#describing-data-layouts title="Permanent link">&para;</a></h3> <p>GC 需要能够处理不同数据类型的 records，也就是需要能够理解对象的内部结构。具体来说，需要知道：</p> <ul> <li>Different length: used when adding scan </li> <li>Field type: used by Forward （Only pointers need to be processed）</li> </ul> <p>编译器通常会为程序中定义的每种对象类型生成 <strong>Type Descriptors</strong> 。每个对象实例在内存中会包含一个指向其类型描述符的引用（通常在对象头中）。</p> <ul> <li>面向对象语言中，对象通常已经拥有指向其类对象的指针，该类对象可以充当或包含类型描述符，因此可能没有额外开销。</li> <li>Statically typed language 中，如果原生不支持此类元数据，则可能需要为每个对象增加 one-word 的开销来存储 Type Descriptors 指针</li> </ul> <p><img alt=image-20250605200216727 src=../ch13.assets/image-20250605200216727.png></p> <h3 id=describing-roots-pointer-map>Describing Roots (Pointer Map)<a class=headerlink href=#describing-roots-pointer-map title="Permanent link">&para;</a></h3> <p>由于 GC 需要从 roots 开始，所以 GC 必须准确识别所有 root，才能追踪到所有存活对象。roots 可以是：</p> <ul> <li>Registers</li> <li>Local variables in stack frames</li> <li>Temporary variables</li> <li>Global variables</li> </ul> <p>中存储的指针，指向 heap。</p> <p>利用 Pointer Map 识别指针：编译时识别出哪个 temp 是 pointer、Stack slot 中是否有指针、寄存器分配时指针属性也会传递给 register，由此构造 map。</p> <p>但是由于 Live temporaries change at every program point，为每一条指令生成一个 map 又不现实，所以选择在 specific program points where garbage collection can occur 时生成 pointer map：</p> <ul> <li>When allocation: inserting before alloc_record</li> <li>Any function call (which might indirectly call alloc_record)</li> </ul> <p>接下来介绍查找 root 的算法：</p> <ol> <li>Start at the top-most stack frame and current PC</li> <li>Look up return address in pointer map </li> <li>Mark(mark-and-sweep)/forward(copy collection) pointers in current frame using the map</li> <li>Move to caller's frame</li> <li>Repeat until all frames are processed</li> </ol> <p><img alt=image-20250605203032962 src=../ch13.assets/image-20250605203032962.png></p> <p>callee-save regs 需要特殊处理 ： 当函数<code>g()</code>调用函数<code>h()</code>，而<code>h()</code>内部触发了GC时，<code>h()</code>可能已经将其自身使用的一些被调用者保存寄存器（其原始值属于<code>g()</code>或更早的调用者）保存到了自己的栈帧中。<code>h()</code>本身可能不知道这些保存的寄存器值哪些是指针。</p> <p>所以，函数的 Pointer Maps 还需要含关于它在调用其他函数时，哪些 callee-save regs 中仍然持有从其调用者（caller）传来的、且仍然活跃的指针的信息。这些信息需要沿着调用链传播。例如，如果<code>f()</code> 调用 <code>g()</code>，<code>g()</code>将一个指针存入被调用者保存寄存器 <code>r_callee_save</code>，然后<code>g()</code>调用<code>h()</code>。在<code>g()</code>调用<code>h()</code>的那个点的指针映射中，必须指明<code>r_callee_save</code>包含一个指针。这样，如果<code>h()</code>（或<code>h()</code>调用的任何函数）触发GC，GC在扫描<code>g()</code>的栈帧（或处理<code>h()</code>保存的<code>r_callee_save</code>副本）时，就能知道<code>r_callee_save</code>的内容需要作为根来处理</p> <h3 id=derived-pointers>Derived Pointers<a class=headerlink href=#derived-pointers title="Permanent link">&para;</a></h3> <p>Derived Pointers 指那些不直接指向堆对象起始地址，而是指向 middle, start, end of object 的指针。</p> <p><img alt=image-20250605212418597 src=../ch13.assets/image-20250605212418597.png></p> <p>在 Copying Collection 中，<strong>when</strong> base pointers are updated to point to new locations, derived pointers need different adjustment logic. 如果 GC 不知道这些派生关系，或者不知道如何计算这个调整，就会导致 derived pointers 失效</p> <p><img alt=image-20250605212522683 src=../ch13.assets/image-20250605212522683.png></p> <p>例：</p> <p><img alt=image-20250605212901728 src=../ch13.assets/image-20250605212901728.png></p> <p>从活跃性分析的角度看，一旦a的值被用于计算t1，后续没有对a的其他引用，a似乎就"死亡"了，然而，对于GC来说，必须保持a存活，因为t1是从a派生的，在GC过程中需要知道a的新地址来正确更新t1。</p> <p>Solution：</p> <ul> <li><strong>Pointer map</strong> ：for each derived pointer, specify which base pointer it's derived from</li> <li><strong>Liveness</strong> ：a derived pointer implicitly keeps its base pointer live!</li> </ul> <!-- Giscus --> <h2 id=__comments>评论</h2> <!-- 这里改成你的Giscus代码 --> <script src=https://giscus.app/client.js data-repo=HobbitQia/notebook data-repo-id=R_kgDOHtZjDg data-category=General data-category-id=DIC_kwDOHtZjDs4CQZ7Z data-mapping=pathname data-strict=0 data-reactions-enabled=1 data-emit-metadata=0 data-input-position=top data-theme=light data-lang=zh-CN crossorigin=anonymous async>
</script> <!-- Reload on palette change --> <script>
    var palette = __md_get("__palette")
    if (palette && typeof palette.color === "object")
        if (palette.color.scheme === "slate") {
            var giscus = document.querySelector("script[src*=giscus]")
            giscus.setAttribute("data-theme", "dark")
        }

    /* Register event handlers after documented loaded */
    document.addEventListener("DOMContentLoaded", function () {
        var ref = document.querySelector("[data-md-component=palette]")
        ref.addEventListener("change", function () {
            var palette = __md_get("__palette")
            if (palette && typeof palette.color === "object") {
                var theme = palette.color.scheme === "slate" ? "dark" : "light"

                /* Instruct Giscus to change theme */
                var frame = document.querySelector(".giscus-frame")
                frame.contentWindow.postMessage(
                    { giscus: { setConfig: { theme } } },
                    "https://giscus.app"
                )
            }
        })
    })
</script> </article> </div> <script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script> </div> <button type=button class="md-top md-icon" data-md-component=top hidden> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8z"/></svg> 回到页面顶部 </button> </main> <footer class=md-footer> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-copyright> <div class=md-copyright__highlight> Copyright &copy; 2023 ~ now | 🚀 Chen Wu (ShiSe) </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> </div> </div> </footer> </div> <div class=md-dialog data-md-component=dialog> <div class="md-dialog__inner md-typeset"></div> </div> <script id=__config type=application/json>{"base": "../..", "features": ["content.code.annotate", "navigation.tracking", "navigation.tabs", "navigation.indexes", "navigation.top"], "search": "../../assets/javascripts/workers/search.973d3a69.min.js", "tags": null, "translations": {"clipboard.copied": "\u5df2\u590d\u5236", "clipboard.copy": "\u590d\u5236", "search.result.more.one": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.other": "\u5728\u8be5\u9875\u4e0a\u8fd8\u6709 # \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.term.missing": "\u7f3a\u5c11", "select.version": "\u9009\u62e9\u5f53\u524d\u7248\u672c"}, "version": null}</script> <script src=../../assets/javascripts/bundle.92b07e13.min.js></script> <script src=../../js/baidu-tongji.js></script> <script src=../../js/katex.js></script> <script src=../../js/mathjax.js></script> <script src=https://gcore.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js></script> <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script> <script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js></script> <script src=https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js></script> </body> </html>